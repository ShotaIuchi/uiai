# Scenario YAML Schema

自然言語ベースのAndroid UIテストシナリオ定義。

## 基本構造

```yaml
name: "シナリオ名"
app: "com.example.app"

steps:
  - id: "セクション名"
    actions:
      - do: "アクションの説明"
      - do: "アクションの説明"
        strict: true              # オプション: このアクションのみ厳格検証
      - then: "期待結果"
        strict: true              # オプション: この検証のみ厳格検証
```

## フィールド

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `name` | ✅ | シナリオ名 |
| `app` | ✅ | パッケージ名 |
| `steps` | ✅ | テストステップのリスト |

### steps 内の要素

| フィールド | 説明 |
|-----------|------|
| `id` | セクション/グループの識別子（任意の文字列） |
| `actions` | セクション内のアクションリスト |
| `replay` | 過去のセクションを再実行（`do`のみ実行、`then`はスキップ） |

### replay フィールド

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `from` | ✅ | 開始セクションのID |
| `to` | ✅ | 終了セクションのID |

**実行ルール**:
1. `from` から `to` までのセクションを順番に処理
2. 対象セクションに `replay` がある場合、それも再帰的に実行
3. 各セクションの `do` アクションのみ実行（`then` はスキップ）
4. `from` と `to` が同じ場合、そのセクションのみ実行
5. `replay` と `actions` が共存する場合、`replay` → `actions` の順で実行

### actions 内の要素

| フィールド | 説明 |
|-----------|------|
| `do` | 実行するアクション（自然言語） |
| `then` | 期待結果・検証内容（自然言語） |
| `wait` | 待機時間（秒）、オプション |
| `strict` | 厳格モード（この要素のみ完全一致検証、オプション）|

**注意**: `do` と `then` は同一行に混在しない。それぞれ独立した行として記述する。

## 例

### 基本的なテスト

```yaml
name: "ログインテスト"
app: "com.example.app"

steps:
  - id: "ログイン"
    actions:
      - do: "アプリを起動"
      - do: "メールアドレス欄に「test@example.com」を入力"
      - do: "パスワード欄に「password123」を入力"
      - do: "「ログイン」ボタンをタップ"
      - then: "ホーム画面が表示されていること"
```

### 複数セクションのテスト

```yaml
name: "拠点切り替えテスト"
app: "com.example.app"

steps:
  - id: "起動"
    actions:
      - do: "アプリを起動"
      - then: "ホーム画面が表示されていること"

  - id: "拠点切り替え"
    actions:
      - do: "メニューをタップ"
      - do: "「拠点切り替え」を選択"
      - then: "「拠点一覧から選択」画面が開いていること"

  - id: "拠点選択"
    actions:
      - do: "「東京本社」をタップ"
      - then: "拠点が「東京本社」に変更されていること"

  - id: "確認"
    actions:
      - do: "ホーム画面に戻る"
      - then: "ヘッダーに「東京本社」と表示されていること"
```

### 待機を含むテスト

```yaml
name: "データ読み込みテスト"
app: "com.example.app"

steps:
  - id: "データ更新"
    actions:
      - do: "アプリを起動"
      - do: "「更新」ボタンをタップ"
        wait: 3
      - then: "最新のデータが表示されていること"
```

### スクロール操作

```yaml
name: "リスト操作テスト"
app: "com.example.app"

steps:
  - id: "スクロールテスト"
    actions:
      - do: "アプリを起動"
      - do: "リストを下にスクロール"
      - do: "「Item 50」が見えるまでスクロール"
      - do: "「Item 50」をタップ"
      - then: "詳細画面が表示されていること"
```

### 入力操作

```yaml
name: "検索テスト"
app: "com.example.app"

steps:
  - id: "検索実行"
    actions:
      - do: "検索アイコンをタップ"
      - do: "「東京」と入力"
      - do: "検索ボタンをタップ"
      - then: "検索結果に「東京」を含む項目が表示されていること"
```

### replay機能（範囲指定）

過去のセクションの `do` アクションを再実行する：

```yaml
name: "リプレイテスト"
app: "com.example.app"

steps:
  - id: "ログイン"
    actions:
      - do: "アプリを起動"
      - do: "ログインボタンをタップ"
      - then: "ホーム画面が表示されていること"

  - id: "データ入力"
    actions:
      - do: "入力フォームを開く"
      - do: "データを入力"
      - then: "入力が完了していること"

  - id: "リプレイ確認"
    replay:
      from: "ログイン"
      to: "データ入力"
    actions:
      - then: "再実行後も正常に動作すること"
```

**実行順序**:
1. `ログイン` の `do`（アプリを起動、ログインボタンをタップ）を実行
2. `データ入力` の `do`（入力フォームを開く、データを入力）を実行
3. `リプレイ確認` の `actions`（then検証）を実行

### replay機能（単一セクション）

`from` と `to` が同じIDの場合、そのセクションのみ再実行：

```yaml
name: "単一リプレイテスト"
app: "com.example.app"

steps:
  - id: "初期設定"
    actions:
      - do: "設定画面を開く"
      - do: "初期設定を実行"
      - then: "設定が完了していること"

  - id: "設定確認"
    replay:
      from: "初期設定"
      to: "初期設定"
    actions:
      - then: "設定が維持されていること"
```

### replay機能（再帰的リプレイ）

リプレイ先のセクションにも `replay` がある場合、その `replay` も再帰的に実行される：

```yaml
name: "再帰的リプレイテスト"
app: "com.example.app"

steps:
  - id: "初期化"
    actions:
      - do: "アプリを起動"

  - id: "ログイン"
    replay:
      from: "初期化"
      to: "初期化"
    actions:
      - do: "ログインボタンをタップ"
      - then: "ホーム画面が表示されていること"

  - id: "操作確認"
    replay:
      from: "ログイン"
      to: "ログイン"
    actions:
      - then: "画面が正しく表示されていること"
```

**実行順序**:
1. `操作確認` の `replay` で `ログイン` を参照
2. `ログイン` に `replay`（初期化）があるので先に実行
3. `初期化` の `do`（アプリを起動）を実行
4. `ログイン` の `do`（ログインボタンをタップ）を実行
5. `操作確認` の `actions`（then検証）を実行

## 自然言語アクションの書き方

### タップ系

```
「ログイン」ボタンをタップ
メニューをタップ
「設定」を選択
右上の×ボタンを押す
OKをタップ
```

### 入力系

```
メールアドレス欄に「test@example.com」を入力
パスワードを入力: secret123
検索ボックスに「キーワード」と入力
```

### スクロール/スワイプ系

```
下にスクロール
リストを上にスクロール
「〇〇」が見えるまでスクロール
左にスワイプ
画面を右にスワイプ
```

### ナビゲーション系

```
戻るボタンを押す
ホームに戻る
前の画面に戻る
```

### 待機系

```
3秒待つ
ローディングが消えるまで待つ
「完了」が表示されるまで待つ
```

### アプリ操作系

```
アプリを起動
アプリを再起動
アプリを終了
```

## 期待結果（then）の書き方

### 画面確認

```
ホーム画面が表示されていること
ログイン画面が開いていること
エラーメッセージが表示されていないこと
```

### 要素確認

```
「東京本社」と表示されていること
リストに5件以上表示されていること
「送信」ボタンが有効になっていること
チェックボックスがONになっていること
```

### 状態確認

```
ログイン状態になっていること
データが更新されていること
選択が解除されていること
```

## 内部処理

エージェントは以下を自動的に行う：

1. **UIツリー取得** - 画面の要素情報を取得
2. **要素特定** - 自然言語からUI要素を特定
   - テキスト一致（「ログイン」→ text="ログイン" の要素）
   - 説明一致（「メニュー」→ content-desc に "menu" を含む要素）
   - クラス推定（「ボタン」→ Button クラス）
3. **座標計算** - 要素の bounds から中心座標を計算
4. **ADBコマンド実行** - 適切なコマンドを生成・実行
5. **検証** - スクリーンショット + Vision API で期待結果を確認

## オプション設定

高度な設定が必要な場合のみ使用：

```yaml
name: "テスト名"
app: "com.example.app"

config:                          # オプション
  timeout: 60                    # 全体タイムアウト（秒）
  clear_data_before: true        # 実行前にアプリデータをクリア
  stop_app_after: true           # 実行後にアプリを停止
  strict: true                   # 厳格モード（全do/thenで完全一致検証）

steps:
  - id: "テスト"
    actions:
      - do: "..."
```

## 厳格モード（Strict Mode）

`strict: true` を指定すると、検証が**完全一致**で行われる。

### 通常モード（デフォルト）

- Vision APIで意味的に判定
- 「〇〇と表示されていること」→ 画面に〇〇らしいものがあればPASS
- 柔軟だが、厳密な判定が必要な場合に不向き

### 厳格モード

- UIツリーのテキストで**完全一致**検証
- `then` 内の「」で囲まれた文字列がUIツリーの `text` 属性に**そのまま存在**するかをチェック
- `do` で要素を特定する際も厳格に一致を要求
- 1文字でも異なればFAIL

### 指定方法

**シナリオ全体に適用**（config）:

```yaml
config:
  strict: true                              # 全do/thenのデフォルト

steps:
  - id: "ログイン"
    actions:
      - do: "「ログイン」ボタンをタップ"     # 完全一致で要素特定
      - then: "「ホーム」と表示されていること" # 完全一致検証
```

**do/then 個別に適用**:

```yaml
steps:
  - id: "ログイン"
    actions:
      - do: "「ログイン」ボタンをタップ"     # 通常モード（柔軟な要素特定）
      - then: "ホーム画面が表示されていること" # 通常モード（Vision判定）

  - id: "拠点確認"
    actions:
      - do: "メニューを開く"
        strict: true                        # このdoのみ厳格に要素特定
      - then: "「東京本社」と表示されていること"
        strict: true                        # このthenのみ完全一致検証
```

**混在パターン**（シナリオ全体は厳格、一部のみ緩和）:

```yaml
config:
  strict: true                              # デフォルトを厳格モードに

steps:
  - id: "ログイン"
    actions:
      - do: "「ログイン」ボタンをタップ"     # 完全一致（config継承）
      - then: "「ホーム」と表示されていること" # 完全一致（config継承）

  - id: "データ確認"
    actions:
      - do: "データを読み込む"
        strict: false                       # このdoのみ柔軟な要素特定
      - then: "リストにデータが表示されていること"
        strict: false                       # このthenのみVision判定
```

### strictの優先順位

1. **actions内の個別指定** (`do.strict` / `then.strict`) - 最優先
2. **config.strict** - デフォルト値として使用
3. **未指定** - `false`（通常モード）

### 厳格モードでの検証対象

| `then` の記述 | 検証対象 |
|---------------|---------|
| `「東京本社」と表示されていること` | UIツリーで `text="東京本社"` を完全一致検索 |
| `「送信」ボタンが表示されていること` | `text="送信"` を完全一致検索 |
| `「エラー」が含まれていること` | `text` に `エラー` を含む要素を検索（部分一致） |

| `do` の記述 | 検証対象 |
|-------------|---------|
| `「ログイン」ボタンをタップ` | `text="ログイン"` を完全一致で要素特定 |
| `メニューをタップ` | content-descやクラス名で柔軟に特定 |

### 部分一致オプション

厳格モードでも部分一致で検証したい場合は `contains` を使う：

```yaml
steps:
  - id: "検索"
    actions:
      - do: "検索する"
      - then: "「検索結果」が含まれていること"   # 部分一致
        strict: true
```

`「〇〇」が含まれていること` という表現の場合、厳格モードでも部分一致になる。

## 注意事項

- `id` はセクションの識別子として使用
- 各セクションは `id` と `actions` を持つ
- `actions` 内で `do` と `then` を記述
- `do` と `then` は同一行に混在不可（別々の行として記述）
- 曖昧な表現は避け、具体的に記述する
  - ❌ 「ボタンを押す」
  - ✅ 「「送信」ボタンをタップ」
- `replay` は既存セクションの `do` のみ再実行（`then` はスキップ）
- `replay` の `from`/`to` には定義済みの `id` を指定すること
